---
import SectionTitle from '@/components/partials/SectionTitle.astro';
import Top from '@/components/partials/Top.astro';
import Container from '@/components/ui/Container.astro';
import Grid from '@/components/ui/Grid.astro';
import Section from '@/components/ui/Section.astro';
import { buildI18nPath } from '@/i18n/utils';
import Layout from '@/layouts/Layout.astro';
import { parseSectionTitle } from '@/scripts/data-parsers/parseSectionTitle';
import type { ColumnSizes } from '@/types';
import ListTagFilter from '@/components/ListTagFilter.astro';
import PaginationContainer from '@/components/PaginationContainer.astro';
import Pagination from '@/components/Pagination.astro';
import type {
  EventListItemFragment,
  EventTag,
  EventsListPageQuery,
  InsightsListItemFragment,
  InsightsListPageQuery,
  InsightsTag,
  NewsroomListItemFragment,
  NewsroomListPageQuery,
  NewsroomTag,
} from '@/__generated__/cms';
import ListFeaturedArticle from '@/components/ListFeaturedArticle.astro';
import ArticlesGrid from '@/components/ArticlesGrid.astro';
import { cn } from '@/scripts/cn';
import { cleanArray } from '@/scripts/cleanArray';
import { initializeStores } from '@/scripts/utils-store-helpers';
import { getTranslations } from '@/scripts/translations';

type InsightsListProps = {
  postType: 'insights';
  data: InsightsListPageQuery;
};
type NewsroomListProps = {
  postType: 'newsroom';
  data: NewsroomListPageQuery;
};
type EventsListProps = {
  postType: 'event';
  data: EventsListPageQuery;
};
interface ArticleListProps {
  lang: string;
  prefix?: string;
  tag?: string;
  paged?: number;
}
type Props = (InsightsListProps | NewsroomListProps | EventsListProps) &
  ArticleListProps;

const {
  postType,
  tag: filterTag = '',
  prefix = postType,
  data,
  lang,
  paged = 1,
} = Astro.props;

const totalPages = data.articles?.pageInfo.pagination?.totalPages ?? 1;
const page = data.page!;
const posts = cleanArray(
  data.articles?.nodes as (
    | InsightsListItemFragment
    | NewsroomListItemFragment
    | EventListItemFragment
  )[]
);
const insightsArticles =
  postType === 'event' ? cleanArray(data.moreArticles?.nodes) : [];

// TAGS
const tags = cleanArray(
  data.filterTags?.nodes as (InsightsTag | NewsroomTag | EventTag)[]
);

initializeStores(data);

const { subpageSettings, articlesListAcf: acf } = page;
// TODO: handle data passed to Layout and Top
const title = subpageSettings?.customTitle || page?.title || '';
const content = subpageSettings?.introduction ?? '';
const image = subpageSettings?.image;
const size = subpageSettings?.topDistribution ?? '5-7';

let rawFeaturedPost;

if (
  postType === 'insights' &&
  acf?.featuredInsightsItem &&
  acf.featuredInsightsItem.node.__typename === 'InsightsItem'
) {
  rawFeaturedPost = acf.featuredInsightsItem.node;
}
if (
  postType === 'newsroom' &&
  acf?.featuredNewsroomItem &&
  acf.featuredNewsroomItem.node.__typename === 'NewsroomItem'
) {
  rawFeaturedPost = acf.featuredNewsroomItem.node;
}
if (
  postType === 'event' &&
  acf?.featuredEvent &&
  acf.featuredEvent.node.__typename === 'Event'
) {
  rawFeaturedPost = acf.featuredEvent.node;
}

if (!rawFeaturedPost && posts?.[0] && !filterTag) {
  rawFeaturedPost = posts.at(0);
}

const listSectionId = 'list';
const TRANSLATIONS = getTranslations();
---

<Layout
  name="insights"
  class="bg-gradient-to-b from-sw-surface-subdued to-transparent py-8 md:py-18"
>
  <Top
    title={title}
    content={content}
    image={image}
    size={size as ColumnSizes}
    breadcrumbs={[
      {
        title: TRANSLATIONS.home,
        url: buildI18nPath('/', lang),
      },
      page.title ?? '',
    ]}
    class="pb-12 md:pb-20"
  >
    {
      !!rawFeaturedPost && (
        <Container class="mt-15">
          <SectionTitle
            hasCustomStyle
            displayAs="overline"
            headline={acf?.featuredItemTitle}
          />
          <Grid class="mt-8 md:mt-15">
            <div
              class={cn('col-span-full', {
                'lg:col-start-2 lg:col-end-12': postType === 'insights',
              })}
            >
              <ListFeaturedArticle
                layout={postType === 'newsroom' ? 'merged' : 'overlapping'}
                data={rawFeaturedPost}
                postType={postType}
              />
            </div>
          </Grid>
        </Container>
      )
    }
  </Top>
  <Section bg="surface-background" id={listSectionId}>
    <Container>
      <SectionTitle
        {...parseSectionTitle(acf?.listTitle?.selectSectionTitle)}
      />

      {
        tags.length > 0 && (
          <ListTagFilter
            allButton
            sectionId={listSectionId}
            tags={tags}
            activeTag={filterTag}
            prefix={prefix}
            class="my-8 md:mb-20 md:mt-12"
          />
        )
      }

      <ArticlesGrid
        postType={postType}
        posts={posts}
        class={cn({ 'mt-8 md:mt-12': tags.length === 0 })}
      />

      {
        totalPages > 1 && (
          <PaginationContainer>
            <Pagination
              sectionId={listSectionId}
              paged={paged}
              totalPages={totalPages}
            />
          </PaginationContainer>
        )
      }
    </Container>
  </Section>
  {
    postType === 'event' && (
      <Fragment>
        {insightsArticles.length > 0 && (
          <Section bg="surface-subdued">
            <Container>
              <SectionTitle withMargin headline={TRANSLATIONS.blog} />
              <ArticlesGrid
                postType="insights"
                posts={insightsArticles}
                columns={4}
              />
            </Container>
          </Section>
        )}
      </Fragment>
    )
  }
</Layout>
