---
import type { ModulesModulesContentListOfEventsLayout } from '@/__generated__/cms';
import ButtonContainer from '@/components/ButtonContainer.astro';
import ModuleContainer from '@/components/ModuleContainer.astro';
import WordpressButtonLink from '@/components/WordpressButtonLink.astro';
import { fetchPostsModuleList } from '@/lib/fetchCMSData';
import type { WithModuleMeta } from '@/types';
import ArticlesGrid from '@/components/ArticlesGrid.astro';
import { getLanguage } from '@/scripts/utils-store-helpers';
import { cleanArray } from '@/scripts/cleanArray';

type Props = WithModuleMeta<ModulesModulesContentListOfEventsLayout>;

const {
  __meta__,
  layoutName,
  backgroundColor,
  limitPosts,
  categoryFilter,
  ctaButton,
} = Astro.props;

const categorySlug = categoryFilter?.nodes?.[0]?.slug;
const { currentLanguage } = getLanguage();

const rawEvents = await fetchPostsModuleList('event', {
  lang: currentLanguage,
  categorySlug,
  limit: limitPosts,
});
const events = cleanArray(rawEvents?.events?.nodes);
---

{
  events.length > 0 && (
    <ModuleContainer meta={__meta__} name={layoutName!} bg={backgroundColor}>
      <ArticlesGrid postType="event" posts={events} />
      <ButtonContainer>
        <WordpressButtonLink data={ctaButton} secondary />
      </ButtonContainer>
    </ModuleContainer>
  )
}
