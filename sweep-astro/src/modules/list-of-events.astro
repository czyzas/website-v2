---
import type { ModulesModulesContentListOfEventsLayout } from '@/__generated__/cms';
import ButtonContainer from '@/components/ButtonContainer.astro';
import ModuleContainer from '@/components/ModuleContainer.astro';
import WordpressButtonLink from '@/components/WordpressButtonLink.astro';
import Card from '@/components/ui/Card.astro';
import Container from '@/components/ui/Container.astro';
import Grid from '@/components/ui/Grid.astro';
import { fetchListOfPostsModuleList } from '@/lib/fetchCMSData';
import { getStore } from '@/scripts/store';
import { languageStore } from '@/stores/languageStore';

type Props = ModulesModulesContentListOfEventsLayout;

const { layoutName, backgroundColor, limitPosts, categoryFilter, ctaButton } =
  Astro.props;

const categorySlug = categoryFilter?.nodes?.[0]?.slug;
// TODO: create useLanguage hook to get current lang from the store automatically
const { currentLanguage } = getStore(languageStore);

const rawEvents = await fetchListOfPostsModuleList('event', {
  lang: currentLanguage.code,
  categorySlug,
  limit: limitPosts,
});
// TODO: Add in-memory caching from IndustriesList component
const events = (rawEvents?.events?.nodes ?? []).filter(Boolean);
---

{
  events.length > 0 && (
    <ModuleContainer name={layoutName!} bg={backgroundColor}>
      <Container>
        <Grid>
          {events.map((event) => (
            <Card class="colspan-full md:col-span-4">
              <span class="text-sw-text-subdued typography-card-title">
                {event.eventAcf?.eventDate}
              </span>
              <div class="typography-h3">{event.title}</div>
            </Card>
          ))}
        </Grid>
        <ButtonContainer>
          <WordpressButtonLink data={ctaButton} secondary />
        </ButtonContainer>
      </Container>
    </ModuleContainer>
  )
}
