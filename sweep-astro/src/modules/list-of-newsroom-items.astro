---
import type { ModulesModulesContentListOfNewsroomItemsLayout } from '@/__generated__/cms';
import ButtonContainer from '@/components/ButtonContainer.astro';
import ModuleContainer from '@/components/ModuleContainer.astro';
import WordpressButtonLink from '@/components/WordpressButtonLink.astro';
import { fetchPostsModuleList } from '@/lib/fetchCMSData';
import { getStore } from '@/scripts/store';
import { languageStore } from '@/stores/languageStore';
import type { WithModuleMeta } from '@/types';
import ArticlesGrid from '@/components/ArticlesGrid.astro';

type Props = WithModuleMeta<ModulesModulesContentListOfNewsroomItemsLayout>;

const {
  __meta__,
  layoutName,
  backgroundColor,
  limitPosts,
  categoryFilter,
  ctaButton,
} = Astro.props;
const categorySlug = categoryFilter?.nodes?.[0]?.slug;
// TODO: create useLanguage hook to get current lang from the store automatically
const { currentLanguage } = getStore(languageStore);
const lang = currentLanguage.code;

const rawPosts = await fetchPostsModuleList('newsroom', {
  lang,
  categorySlug,
  limit: limitPosts,
});
const posts = (rawPosts?.newsroomItems?.nodes ?? []).filter(Boolean);
---

{
  posts.length > 0 && (
    <ModuleContainer meta={__meta__} name={layoutName!} bg={backgroundColor}>
      <ArticlesGrid postType="newsroom" posts={posts} columns={4} />
      <ButtonContainer>
        <WordpressButtonLink data={ctaButton} secondary />
      </ButtonContainer>
    </ModuleContainer>
  )
}
