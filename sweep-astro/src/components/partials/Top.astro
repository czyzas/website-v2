---
import type { HTMLAttributes } from 'astro/types';
import { parseLink } from '@/scripts/data-parsers/parseLink';
import type { UnparsedLink } from '@/scripts/data-parsers/parseLink';
import { cn } from '@/scripts/cn';
import type { UnparsedImage } from '@/scripts/data-parsers/parseImage';
import type { ColumnSizes } from '@/types';
import Container from '../ui/Container.astro';
import Button from '../ui/Button.astro';
import WordpressImage from '../WordpressImage.astro';
import Grid from '../ui/Grid.astro';
import Breadcrumbs from '../Breadcrumbs.astro';

interface TopProps {
  title?: string;
  /** @default 'h1' */
  titleSize?: 'h1' | 'h2';
  content?: string;
  link?: UnparsedLink;
  image?: UnparsedImage;
  size?: ColumnSizes;
  breadcrumbs?: [...UnparsedLink[], string];
}

type Props = HTMLAttributes<'section'> & TopProps;

const {
  title,
  titleSize = 'h1',
  content,
  link: unparsedLink,
  image,
  size = '5-7',
  breadcrumbs,
  class: className,
  ...props
} = Astro.props;

const link = parseLink(unparsedLink);
const sizes: Record<ColumnSizes, [string, string]> = {
  '5-7': ['md:col-span-5', 'md:col-span-7'],
  '6-6': ['md:col-span-6', 'md:col-span-6'],
  '7-5': ['md:col-span-7', 'md:col-span-5'],
};
const titleSizes = {
  h1: 'typography-h1 md:typography-h1',
  h2: 'typography-h2',
} as const;

const hasImage = image || Astro.slots.has('image');
const [contentColumnSize, imageColumnSize] = hasImage
  ? sizes?.[size] ?? sizes['5-7']
  : [];
---

<section
  {...props}
  class={cn(
    'top',
    'bg-gradient-to-b from-sw-surface-subdued to-transparent',
    className
  )}
>
  <Container>
    <Grid class="gap-y-8">
      <div
        class={cn(
          'col-span-full',
          contentColumnSize,
          'flex flex-col items-start justify-center gap-4'
        )}
      >
        {
          breadcrumbs && breadcrumbs.length > 0 && (
            <Breadcrumbs breadcrumbs={breadcrumbs} />
          )
        }
        <h1
          class={titleSizes?.[titleSize] ?? titleSizes.h1}
          set:html={title ?? ''}
        />
        <div
          class="typography-body md:max-w-[22.125rem]"
          set:html={content ?? ''}
        />
        {
          link.shouldRender && (
            <Button
              asLink
              href={link.url}
              target={link.target}
              class="w-full md:w-auto hidden md:inline-flex"
            >
              {link.title}
            </Button>
          )
        }
      </div>
      {
        hasImage && (
          <div
            class={cn(
              'col-span-full',
              imageColumnSize,
              'flex items-center justify-end'
            )}
          >
            <slot name="image">
              <WordpressImage data={image} loading="eager" class="rounded-lg" />
            </slot>
          </div>
        )
      }
      {
        link.shouldRender && (
          <Button
            asLink
            href={link.url}
            target={link.target}
            class="col-span-full inline-flex md:hidden w-full"
          >
            {link.title}
          </Button>
        )
      }
    </Grid>
  </Container>

  <slot />
</section>
