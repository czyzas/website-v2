---
import { cmsStore } from '@/stores/cmsStore';
import { getStore } from '@/scripts/store';
import { parseSectionTitle } from '@/scripts/data-parsers/parseSectionTitle';
import { parseLink } from '@/scripts/data-parsers/parseLink';
import { buildI18nPath } from '@/scripts/buildI18nPath';
import Container from '../ui/Container.astro';
import Button from '../ui/Button.astro';
import SectionTitle from '../partials/SectionTitle.astro';
import SwiperNavigation from '../SwiperNavigation.astro';
import ButtonContainer from '../ButtonContainer.astro';
import WordpressImage from '../WordpressImage.astro';

const store = getStore(cmsStore);
const data = store.homepage!;
const acf = data.homepage!.resources!;
const button = parseLink(acf.button);

const resources = acf.resources?.nodes ?? [];
---

<script>
  import Swiper from 'swiper';
  import { Navigation } from 'swiper/modules';

  const resourceSwiperContainers =
    document.querySelectorAll<HTMLElement>('.resources-swiper');
  for (const swiperContainer of resourceSwiperContainers) {
    const prevButton = swiperContainer
      .closest('section.resources')
      ?.querySelector<HTMLButtonElement>('.swiper-navigation-prev');
    const nextButton = swiperContainer
      .closest('section.resources')
      ?.querySelector<HTMLButtonElement>('.swiper-navigation-next');

    new Swiper(swiperContainer, {
      modules: [Navigation],
      slidesPerView: 1,
      spaceBetween: 16,
      breakpoints: {
        640: {
          slidesPerView: 2,
        },
        1024: {
          slidesPerView: 3,
        },
      },
      navigation: {
        prevEl: prevButton,
        nextEl: nextButton,
      },
    });
  }
</script>

<style>
  .swiper {
    @apply overflow-visible;
  }

  .swiper-slide {
    @apply self-stretch h-auto flex;
  }
</style>

<section class="resources py-12 md:py-20 bg-sw-surface-subdued overflow-hidden">
  <Container>
    <SectionTitle
      withMargin
      {...parseSectionTitle(acf.sectionTitle?.selectSectionTitle)}
    />

    <div class="swiper resources-swiper">
      <div class="swiper-wrapper">
        {
          resources.map((resource) => {
            if (resource.__typename !== 'LibraryItem') return null;

            return (
              <div class="swiper-slide">
                <a
                  href={buildI18nPath(resource.uri)}
                  class="w-full h-full border border-sw-border rounded-lg overflow-hidden shadow-button-secondary"
                >
                  <div class="image-container aspect-[16/9] sm:aspect-[28/19]">
                    <WordpressImage
                      data={resource.subpageSettings?.image}
                      preferredWidth={586}
                      class="w-full h-full object-cover"
                    />
                  </div>
                  <div class="content-container p-6 flex flex-col gap-4">
                    <p class="typography-card-title text-sw-text-subdued">
                      Insight
                    </p>
                    <h3
                      class="typography-cards-bold-large"
                      set:html={resource.title}
                    />
                  </div>
                </a>
              </div>
            );
          })
        }
      </div>
    </div>

    <ButtonContainer class="mt-8 md:mt-15 flex-col sm:flex-row">
      <SwiperNavigation class="shrink-0" />
      {
        button.shouldRender && (
          <Button
            asLink
            trailingIcon="arrow-right"
            href={button.url}
            target={button.target}
            class="w-full md:w-auto"
          >
            {button.title}
          </Button>
        )
      }
    </ButtonContainer>
  </Container>
</section>
