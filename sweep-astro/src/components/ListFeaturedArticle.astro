---
import type { HTMLAttributes } from 'astro/types';
import type {
  EventListItemFragment,
  InsightsListItemFragment,
  NewsroomListItemFragment,
} from '@/__generated__/cms';
import type { WithAttributes } from '@/types';
import { cn } from '@/scripts/cn';
import { parseTags } from '@/scripts/data-parsers/parseTag';
import EventDate from '@/components/EventDate.astro';
import { getFeaturedArticleCtaText } from '@/scripts/postTypeOptions';
import WordpressButtonLink from './WordpressButtonLink.astro';
import Prose from './ui/Prose.astro';
import CardWithMergedImage from './CardWithMergedImage.astro';
import CardWithBigImage from './CardWithBigImage.astro';
import ArticleTag from './ArticleTag.astro';

type UnparsedArticle =
  | InsightsListItemFragment
  | NewsroomListItemFragment
  | EventListItemFragment;

interface ListFeaturedArticleProps extends HTMLAttributes<'div'> {
  data?: UnparsedArticle;
  layout?: CardLayout;
  postType: 'newsroom' | 'insights' | 'event';
}
type Props = WithAttributes<ListFeaturedArticleProps>;

const {
  class: className,
  data,
  layout = 'overlapping',
  postType,
  ...props
} = Astro.props;

const uri = data?.uri;
const title = data?.title;
const category = data?.categories?.nodes?.[0]?.name;
const content = data?.subpageSettings?.introduction;
const image = data?.subpageSettings?.image;
const tags = parseTags(data?.tags?.nodes);

type CardLayout = keyof typeof layouts;

const layouts = {
  // side: CardWithSideImage,
  overlapping: CardWithBigImage,
  // spaced: CardWithImageSpaced,
  merged: CardWithMergedImage,
} as const;

const ContentWrapper =
  layout in layouts ? layouts[layout as CardLayout] : layouts.overlapping;
---

{
  !!data && (
    <ContentWrapper
      {...props}
      image={image}
      size={layout === 'merged' ? 'lg' : undefined}
      class={cn(
        'list-featured-article',
        { 'bg-white': postType === 'newsroom' },
        className
      )}
      widerCard={postType === 'insights'}
    >
      <div class="flex flex-1 flex-col items-start gap-4">
        {!!category && (
          <div class="typography-card-title text-sw-text-subdued">
            {category}
          </div>
        )}
        {!!title && (
          <div class="flex items-center gap-4 md:gap-8">
            {data.__typename === 'Event' && data.eventAcf?.eventDate && (
              <EventDate
                date={data.eventAcf.eventDate}
                class="border border-sw-text-disabled"
              />
            )}
            <div class="typography-cards-bold-large">{title}</div>
          </div>
        )}
        {!!content && <Prose set:html={content} />}
        {!!uri && (
          <WordpressButtonLink
            data={{
              url: uri,
              title: getFeaturedArticleCtaText(data.__typename),
            }}
            arrow
          />
        )}
        {tags.length > 0 && (
          <div class="tags mt-auto flex flex-wrap gap-2.5">
            {tags.map((tag) =>
              tag.shouldRender ? (
                <ArticleTag color={tag.color}>{tag.name}</ArticleTag>
              ) : null
            )}
          </div>
        )}
      </div>
    </ContentWrapper>
  )
}
