---
import type { InferGetStaticParamsType } from 'astro';
import Layout from '@/layouts/Layout.astro';
import { fixLangParams, getLangParam, getUrlWithoutLang } from '@/i18n/utils';
import {
  fetchDefaultPage,
  fetchDefaultPagesStaticPaths,
} from '@/lib/fetchCMSData';
import type { Locales } from '@/i18n/config';

export const getStaticPaths = async () => {
  const paths = await fetchDefaultPagesStaticPaths();
  const returnPaths = [];
  for (const staticPath of paths) {
    if (
      staticPath.template?.templateName !== 'Default' ||
      !staticPath?.languageCode ||
      !staticPath?.uri
    ) {
      continue;
    }

    const paramPath = getUrlWithoutLang(staticPath.uri);

    returnPaths.push({
      params: {
        lang: getLangParam(staticPath.languageCode),
        page: paramPath,
      },
      props: staticPath,
    });
  }

  return returnPaths;
};

type Params = InferGetStaticParamsType<typeof getStaticPaths>;

const { lang = 'en', page = '' } = fixLangParams(
  Astro.params,
  'page'
) as Params;

const { slug = '' } = Astro.props;
const data = (await fetchDefaultPage(slug, lang as Locales)) ?? {};
export const prerender = true;
---

<Layout>
  <h1>Dynamic page on root level</h1>
  <p>Title: {data.title}</p>
  <p>Lang: {lang}</p>
  <p>URL: {`/${page}`}</p>
</Layout>
